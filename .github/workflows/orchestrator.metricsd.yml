name: orc8r-metricsd

on:
  push:
    paths:
      - "orchestrator-bundle/orc8r-metricsd-operator/**"

jobs:
  orc8r-metricsd-lint-report:
    uses: ./.github/workflows/lint-report.yml
    with:
      charm_dir: orc8r-metricsd-operator

  orc8r-metricsd-static-analysis:
    uses: ./.github/workflows/static-analysis.yml
    with:
      charm_dir: orc8r-metricsd-operator

  orc8r-metricsd-unit-tests-with-coverage:
    uses: ./.github/workflows/unit-tests.yml
    with:
      charm_dir: orc8r-metricsd-operator

  orc8r-metricsd-integration-test:
    name: Integration tests (orc8r-metricsd)
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup operator environment
        uses: charmed-kubernetes/actions-operator@main
        with:
          provider: microk8s
      - name: Run integration tests
        run: cd orchestrator-bundle/orc8r-metricsd-operator && tox -e integration
      - name: Archive charmcraft logs
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: charmcraft-logs
          path: /home/runner/snap/charmcraft/common/cache/charmcraft/log/*.log

  orc8r-metricsd-charmhub-upload:
    if: github.ref_name == 'main'
    uses: ./.github/workflows/upload-charm.yml
    secrets: inherit
    with:
      charm: orc8r-metricsd
